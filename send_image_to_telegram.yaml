blueprint:
  name: Voice - Send Image to Telegram
  author: Thaidv
  description: >
    üñºÔ∏è G·ª≠i ·∫£nh t·ªõi Telegram d√πng cho Voice Assistant  
    ‚úÖ ƒê√£ s·ª≠a l·ªói c√∫ ph√°p YAML ("mapping values are not allowed here")  
    ‚úÖ ƒê√£ s·ª≠a l·ªói `expected int @ data['target']  
    ‚úÖ G·ª≠i ƒë√∫ng nh√≥m Telegram theo Chat ID nh·∫≠p.
  domain: script
  homeassistant:
    min_version: 2024.10.0

  source_url: https://github.com/thaibacgiang/thaibot/blob/main/send_image_to_telegram.yaml

mode: queued
max: 30
max_exceeded: silent

input:
  chat_id:
    name: Chat ID
    description: "Nh·∫≠p chat_id nh√≥m ho·∫∑c ng∆∞·ªùi nh·∫≠n (VD: -1002936213456)"
    selector:
      text:
        multiline: false
        multiple: false

  caption:
    name: Caption
    description: "M√¥ t·∫£/ghi ch√∫ cho ·∫£nh (t√πy ch·ªçn)"
    default: ""
    selector:
      text:
        multiline: true
        multiple: false

  image_path:
    name: Image Path
    description: >
      ƒê√¢y l√† URL ·∫£nh c·∫ßn g·ª≠i.  
      V√≠ d·ª•:
        - http://localhost:1984/api/frame.jpeg?src=camera.ezvizkho  
        - http://localhost:1984/api/frame.jpeg?src=camera.ezvizcong
    selector:
      text:
        multiline: false
        multiple: false

  message:
    name: Message
    description: "N·ªôi dung tin nh·∫Øn ƒëi k√®m (tu·ª≥ ch·ªçn)"
    default: ""
    selector:
      text:
        multiline: true
        multiple: false

variables:
  version: 20251014

sequence:
  # L√†m s·∫°ch d·ªØ li·ªáu ƒë·∫ßu v√†o
  - variables:
      _chat_id: "{{ chat_id | int }}"
      _image_path: "{{ image_path | trim }}"
      _caption: "{{ caption | default('') | trim }}"
      _message: "{{ message | default('') | trim }}"
      _final_caption: "{{ _message if _message else _caption }}"

  # G·ª≠i ·∫£nh ƒë·∫øn Telegram
  - action: telegram_bot.send_photo
    data:
      target: "{{ _chat_id }}"
      url: "{{ _image_path }}"
      caption: "{{ _final_caption }}"
    response_variable: telegram_result

  # Ki·ªÉm tra ph·∫£n h·ªìi Telegram
  - choose:
      - conditions:
          - condition: template
            value_template: "{{ telegram_result is defined and telegram_result != false }}"
        sequence:
          - variables:
              response:
                status: success
                message: "‚úÖ G·ª≠i ·∫£nh th√†nh c√¥ng!"
    default:
      - variables:
          response:
            status: failed
            message: "‚ùå G·ª≠i ·∫£nh th·∫•t b·∫°i!"

  - stop: ""
    response_variable: response
