blueprint:
  name: Voice - Send Image to Telegram
  author: Thaidv1
  description: >
    ğŸ“¸ Gá»­i áº£nh tá»« Camera Ä‘áº¿n Telegram â€” phiÃªn báº£n sá»­a lá»—i hoÃ n toÃ n.
    - Há»— trá»£ lá»c URL Markdown.
    - KhÃ´ng cÃ²n lá»—i LoggingUndefined.
    - Hiá»ƒn thá»‹ caption rÃµ rÃ ng vÃ  thÃ¢n thiá»‡n.

  domain: script
  homeassistant:
    min_version: 2024.10.0

  input:
    telegram_settings:
      name: CÃ i Ä‘áº·t Telegram
      icon: mdi:telegram
      input:
        chat_id:
          name: Chat ID
          description: ID nhÃ³m hoáº·c ngÆ°á»i nháº­n áº£nh.
          selector:
            text:
              multiline: false
        caption:
          name: Caption máº·c Ä‘á»‹nh
          description: Ghi chÃº Ä‘i kÃ¨m áº£nh (náº¿u khÃ´ng cÃ³ message riÃªng).
          selector:
            text:
              multiline: true
          default: ''

    prompt_settings:
      name: CÃ i Ä‘áº·t gá»£i Ã½ cho AI
      icon: mdi:robot
      collapsed: true
      input:
        image_path_prompt:
          name: Gá»£i Ã½ Ä‘Æ°á»ng dáº«n áº£nh
          description: >
            Gá»£i Ã½ giÃºp AI biáº¿t chá»n URL camera nÃ o. Nháº­p URL áº£nh há»£p lá»‡ (http/https),
            vÃ­ dá»¥: http://192.168.1.23:1984/api/frame.jpeg?src=cam_cua_truoc
          selector:
            text:
              multiline: true
          default: >
            - NhÃ  xe: http://192.168.1.23:1984/api/frame.jpeg?src=cam_nha_xe
            - Cá»­a trÆ°á»›c: http://192.168.1.23:1984/api/frame.jpeg?src=cam_cua_truoc
            - PhÃ²ng khÃ¡ch: http://192.168.1.23:1984/api/frame.jpeg?src=cam_phong_khach
        message_prompt:
          name: Gá»£i Ã½ ná»™i dung tin nháº¯n
          description: >
            Nháº­p tÃªn camera hoáº·c mÃ´ táº£ áº£nh. VD: "áº¢nh tá»« Camera cá»­a trÆ°á»›c"
          selector:
            text:
              multiline: true
          default: >
            "áº¢nh tá»« Camera cá»­a trÆ°á»›c" hoáº·c "Camera cam_cua_truoc snapshot"

  source_url: https://github.com/thaibacgiang/thaibot/blob/main/send_image_to_telegram.yaml

mode: queued
max: 30
max_exceeded: silent

variables:
  version: 20251024

fields:
  image_path:
    name: Image Path
    description: !input image_path_prompt
    selector:
      text:
    required: true

  message:
    name: Message
    description: !input message_prompt
    selector:
      text:

sequence:
  - variables:
      raw_path: "{{ image_path | default('') | trim }}"
      # XÃ³a Ä‘á»‹nh dáº¡ng Markdown kiá»ƒu [url](url)
      clean_path: >
        {% if '(' in raw_path and ')' in raw_path %}
          {{ raw_path | regex_replace('\\[.*?\\]\\((.*?)\\)', '\\1') }}
        {% else %}
          {{ raw_path }}
        {% endif %}
      final_caption: "{{ message if message|length > 0 else (caption | default('')) }}"

  - alias: "ğŸ“¤ Gá»­i áº£nh Ä‘áº¿n Telegram"
    action: telegram_bot.send_photo
    data:
      chat_id: !input chat_id
      url: "{{ clean_path }}"
      caption: "{{ final_caption }}"
    response_variable: telegram_result

  - choose:
      - conditions:
          - condition: template
            value_template: "{{ telegram_result is defined and telegram_result is not none }}"
        sequence:
          - variables:
              response:
                data:
                  status: "âœ… ThÃ nh cÃ´ng"
                  message: "áº¢nh Ä‘Ã£ Ä‘Æ°á»£c gá»­i Ä‘áº¿n Telegram"
    default:
      - variables:
          response:
            data:
              status: "âŒ Tháº¥t báº¡i"
              message: "KhÃ´ng thá»ƒ gá»­i áº£nh â€“ kiá»ƒm tra láº¡i URL hoáº·c káº¿t ná»‘i Telegram"

  - stop: "{{ response }}"
