blueprint:
  name: Voice - Send Image to Telegram
  author: Thaidv
  description: >
    üñºÔ∏è G·ª≠i ·∫£nh t·ªõi Telegram d√πng cho Voice Assistant  
    ‚úÖ Phi√™n b·∫£n ƒë√£ s·ª≠a l·ªói `expected int @ data['target']  
    ‚úÖ ƒê·∫£m b·∫£o g·ª≠i ƒë√∫ng nh√≥m Telegram theo Chat ID nh·∫≠p.
  domain: script
  homeassistant:
    min_version: 2024.10.0

  input:
    telegram_settings:
      name: C·∫•u h√¨nh Telegram
      icon: mdi:telegram
      description: C·∫•u h√¨nh g·ª≠i ·∫£nh Telegram
      input:
        chat_id:
          name: Chat ID
          description: Nh·∫≠p chat_id nh√≥m ho·∫∑c ng∆∞·ªùi nh·∫≠n (VD: -1002936213456)
          selector:
            text:
              multiline: false
              multiple: false
        caption:
          name: Caption
          description: M√¥ t·∫£/ghi ch√∫ cho ·∫£nh (t√πy ch·ªçn)
          selector:
            text:
              multiline: true
              multiple: false
          default: ''

    prompt_settings:
      name: Prompt settings cho AI (n·∫øu d√πng LLM)
      icon: mdi:robot
      description: C·∫•u h√¨nh nh·∫Øc cho m√¥ h√¨nh AI (n·∫øu c·∫ßn)
      collapsed: true
      input:
        image_path_prompt:
          name: Image Path Prompt
          description: H∆∞·ªõng d·∫´n AI nh·∫≠p ƒë√∫ng ƒë∆∞·ªùng d·∫´n ·∫£nh
          selector:
            text:
              multiline: true
              multiple: false
          default: >
            ƒê√¢y l√† tham s·ªë b·∫Øt bu·ªôc. Cung c·∫•p URL ƒë·∫ßy ƒë·ªß cho ·∫£nh c·∫ßn g·ª≠i.  
            V√≠ d·ª•:
              - Kho: http://localhost:1984/api/frame.jpeg?src=camera.ezvizkho
              - C·ªïng: http://localhost:1984/api/frame.jpeg?src=camera.ezvizcong
              - S√¢n: http://localhost:1984/api/frame.jpeg?src=camera.ezvizsan
              - Ph√≤ng Kh√°ch: http://localhost:1984/api/frame.jpeg?src=camera.pkhach

        message_prompt:
          name: Message Prompt
          description: H∆∞·ªõng d·∫´n AI nh·∫≠p n·ªôi dung tin nh·∫Øn
          selector:
            text:
              multiline: true
              multiple: false
          default: >
            Tu·ª≥ ch·ªçn. C√≥ th·ªÉ nh·∫≠p t√™n camera ho·∫∑c n·ªôi dung m√¥ t·∫£ ng·∫Øn cho ·∫£nh.

  source_url: https://github.com/thaibacgiang/thaibot/blob/main/send_image_to_telegram.yaml
mode: queued
max: 30
max_exceeded: silent

variables:
  version: 20251014

fields:
  image_path:
    name: Image Path
    description: !input image_path_prompt
    selector:
      text:
    required: true
  message:
    name: Message
    description: !input message_prompt
    selector:
      text:

sequence:
  # Bi·∫øn ƒë·∫ßu v√†o
  - variables:
      image_path: "{{ image_path | default('') | trim }}"
      message: "{{ message | default('') | trim }}"
      final_caption: "{{ message if message else (caption | default('')) }}"

  # G·ª≠i ·∫£nh qua Telegram
  - action: telegram_bot.send_photo
    data:
      target: "{{ chat_id | int }}"        # ‚úÖ √âp ki·ªÉu integer, s·ª≠a l·ªói expected int
      url: "{{ image_path }}"
      caption: "{{ final_caption }}"
    response_variable: telegram_result

  # Ki·ªÉm tra ph·∫£n h·ªìi t·ª´ Telegram
  - choose:
      - conditions:
          - condition: template
            value_template: "{{ telegram_result is defined and telegram_result != false }}"
        sequence:
          - variables:
              response:
                data:
                  status: success
                  message: "‚úÖ G·ª≠i ·∫£nh th√†nh c√¥ng!"
    default:
      - variables:
          response:
            error: "‚ùå G·ª≠i ·∫£nh th·∫•t b·∫°i!"

  - stop: ""
    response_variable: response
