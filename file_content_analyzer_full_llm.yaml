blueprint:
  name: Voice - File Content Analyzer
  author: DoThai
  description: >
    PhÃ¢n tÃ­ch hÃ¬nh áº£nh tá»« camera vÃ  tá»± Ä‘á»™ng lÆ°u snapshot vÃ o thÆ° má»¥c theo ngÃ y trong /config/www/AnhAI/YYYY-MM-DD/
  domain: script
  homeassistant:
    min_version: 2025.8.0

  input:
    ai_task_entity:
      name: AI Task Entity
      description: "Entity cá»§a AI Task (vÃ­ dá»¥: ai_task.gemini_2_5_flash_ai_task)"
      selector:
        entity:
          filter:
            domain: ai_task

    instructions_prompt:
      name: Instructions
      description: "YÃªu cáº§u AI cáº§n thá»±c hiá»‡n (máº·c Ä‘á»‹nh: phÃ¡t hiá»‡n ngÆ°á»i trong áº£nh)"
      selector:
        text:
          multiline: true
      default: "PhÃ¢n tÃ­ch xem cÃ³ ngÆ°á»i trong khung hÃ¬nh hay khÃ´ng"

fields:
  camera_entity:
    name: Camera Entity
    description: "Camera cáº§n phÃ¢n tÃ­ch"
    selector:
      entity:
        filter:
          domain: camera
    required: true

  instructions:
    name: Instructions
    description: "Ghi Ä‘Ã¨ yÃªu cáº§u náº¿u muá»‘n"
    selector:
      text:
        multiline: true

mode: parallel
max_exceeded: silent

sequence:
  # ğŸ§© Táº¡o biáº¿n vÃ  Ä‘Æ°á»ng dáº«n
  - variables:
      ai_task_entity: !input ai_task_entity
      camera_entity: "{{ camera_entity }}"
      instructions: "{{ instructions or instructions_prompt }}"
      today: "{{ now().strftime('%Y-%m-%d') }}"
      folder_path: "/config/www/AnhAI/{{ today }}"
      filename: "snapshot_{{ camera_entity.split('.')[-1] }}.jpg"
      snapshot_file: "{{ folder_path }}/{{ filename }}"



  # ğŸ“¸ Chá»¥p áº£nh camera lÆ°u vÃ o Ä‘Ãºng thÆ° má»¥c theo ngÃ y
  - service: camera.snapshot
    data:
      entity_id: "{{ camera_entity }}"
      filename: "{{ snapshot_file }}"

  # ğŸ”— Táº¡o Ä‘Æ°á»ng dáº«n media-source Ä‘á»ƒ AI Ä‘á»c
  - variables:
      media_path: "local/AnhAI/{{ today }}/{{ filename }}"

  # ğŸ¤– Gá»i AI Task xá»­ lÃ½ áº£nh
  - service: ai_task.generate_data
    data:
      task_name: "Analyze camera snapshot"
      instructions: "{{ instructions }}"
      attachments:
        - media_content_id: "media-source://media_source/{{ media_path }}"
          media_content_type: "image/jpeg"
      entity_id: "{{ ai_task_entity }}"
    response_variable: result

  # ğŸ§¹ (Tuá»³ chá»n) â€“ cÃ³ thá»ƒ thÃªm bÆ°á»›c xoÃ¡ file sau khi xá»­ lÃ½ xong
  # - service: shell_command.delete_snapshot
  #   data:
  #     file: "{{ snapshot_file }}"

  - variables:
      response: "{{ result.data | default('KhÃ´ng cÃ³ pháº£n há»“i tá»« AI.') }}"

  - stop: "{{ response }}"
